<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coffee - Principal</title>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/assets/css/principal.css">
    
    <script src="https://cdn.tailwindcss.com"></script> 
    
    <style>
        ::-webkit-scrollbar {
            width: 4px;
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 9999px;
        }
    </style>
</head>

<body>

    <header>
        <nav class="navbar">
            <a href="index.html" class="logo">Coffee</a>
            <ul class="nav-links">
                <li><a href="catalogo.html" target="conteudo">Loja</a></li>
                <li><a href="cursos.html" class="active" target="conteudo">Aulas</a></li>
                <li><a href="planos.html" target="conteudo">Planos</a></li>
                <li><a href="blog.html" target="conteudo">Blog</a></li>
                <li>
                <a href="carrinho.html" target="conteudo">
                    <i class="fa-solid fa-cart-shopping"></i>
                </a>
                </li>
            </ul>
            <div class="auth-buttons">
                <a href="#" class="btn btn-login">Login</a>
                <a href="#" class="btn btn-cadastro">Cadastro</a>
            </div>
        </nav>
    </header>

    <main>
        <iframe name="conteudo" src="catalogo.html" width="100%" frameborder="0"></iframe>
    </main>
<button id="chat-toggle"
                            class="fixed bottom-6 right-6 bg-amber-700 hover:bg-amber-800 text-white rounded-full p-4 shadow-lg z-50 focus:outline-none flex items-center justify-center">
                            
                            <i class="fas fa-comments text-2xl"></i>
                            
                        </button>
                            <div id="chat-widget"
                                class="fixed bottom-20 right-6 w-80 h-96 bg-white rounded-xl shadow-lg border border-gray-300 flex flex-col overflow-hidden z-50 mb-5 hidden">
                                <div class="bg-amber-600 text-white px-4 py-3 font-semibold flex justify-between">
                                    <span>Atendimento Virtual</span>
                                    <i class="cursor-pointer" onclick="triggerClick('chat-toggle')">üóô</i>
                                </div>
                                <div id="chat-box" class="flex-1 px-4 py-2 space-y-2 overflow-y-auto h-64 text-sm">
                                    <div class="text-gray-700 italic">Vamos Falar sobre caf√©...</div>
                                </div>
                                <div class="flex items-center text-gray-700 border-gray-700 px-2 py-2">
                                    <input type="text" id="user-input" placeholder="Digite sua mensagem..."
                                        class="flex-1 border border-gray-700 rounded px-3 py-2 text-sm focus:outline-none">
                                    <button onclick="sendMessage()" class="ml-2 text-amber-700 hover:text-blue-800 text-sm">Enviar</button>
                                </div>
                            </div>
    <footer class="ecommerce-footer">

        <div class="footer-top-bar">
            <div class="footer-container">
                <div class="form-pagamento">
                    <h4>FORMAS DE PAGAMENTO</h4>
                    <div class="icones-pagamento">
                        <img src="images/forma-pagamento.png" alt="Formas de Pagamento" class="pagamento-img">
                    </div>
                </div>

                <div class="seguranca">
                    <h4>SEGURAN√áA</h4>
                    <div class="selos-seguranca">
                        <img src="images/google-safe.png" alt="Google Safe Browsing" class="selo-img-google">
                        <img src="images/selo.png" alt="Selo NlQ Ebit" class="selo-img-ebit">
                    </div>
                </div>
            </div>
        </div>
        
        <div class="footer-links">
            <div class="footer-container main-links-grid">
                
                <div class="coluna">
                    <h4 class="coluna-titulo">INSTITUCIONAL</h4>
                    <ul class="lista-links">
                        <li><a href="#">Quem somos</a></li>
                        <li><a href="#">Termos e Condi√ß√µes de Venda</a></li>
                        <li><a href="#">Pol√≠tica de troca e devolu√ß√µes</a></li>
                        <li><a href="#">Pol√≠tica de Seguran√ßa e Privacidade</a></li>
                        
                        <li><a href="#">Pol√≠tica de Cookies</a></li>
                    </ul>
                </div>
                
                <div class="coluna">
                    <h4 class="coluna-titulo">D√öVIDAS</h4>
                    <ul class="lista-links">
                        <li><a href="#">Como comprar</a></li>
                        <li><a href="#">Prazos e entregas</a></li>
                        <li><a href="#">Formas de Pagamento</a></li>
                        <li><a href="#">Programa de Parceiros</a></li>
                    </ul>
                </div>
                
                <div class="coluna">
                    <h4 class="coluna-titulo">CLIENTE</h4>
                    <ul class="lista-links">
                        <li><a href="#">Minha conta</a></li>
                        <li><a href="#">Meus pedidos</a></li>
                        <li><a href="#">Meus tickets</a></li>
                    </ul>
                </div>
                
                <div class="coluna">
                    <h4 class="coluna-titulo">AJUDA</h4>
                    <ul class="lista-links">
                        <li><a href="#">V√≠deo Tutoriais</a></li>
                        <li><a href="#">Manuais do Produto</a></li>
                        <li><a href="#">Fale Conosco</a></li>
                    </ul>
                </div>

            </div>
        </div>

        <div class="footer-bottom">
            <div class="footer-container">
                <div class="siga-nos">
                    <h4 class="titulo-siga">SIGA-NOS</h4>
                    <div class="social-icons">
                        <a href="#" aria-label="WhatsApp"><i class="fab fa-whatsapp"></i> </a>
                        <a href="#" aria-label="Instagram"><i class="fab fa-instagram"></i> </a>
                        <a href="#" aria-label="X (Twitter)"><i class="fab fa-x-twitter"></i> </a>
                        <a href="#" aria-label="Facebook"><i class="fab fa-facebook-f"></i> </a>
                    </div>
                </div>
            </div>
        </div>
    </footer>




   <script>
    // ----------------------------------------------------
    // CONFIGURA√á√ÉO
    // ----------------------------------------------------
    // URL do seu endpoint Express que se comunica com o Gemini
    const GEMINI_ENDPOINT = '/api/chatbot'; 

    // ----------------------------------------------------
    // VARI√ÅVEIS DO DOM
    // ----------------------------------------------------
    const chatWidget = document.getElementById('chat-widget');
    const toggleBtn = document.getElementById('chat-toggle');
    const chatBox = document.getElementById('chat-box');
    const input = document.getElementById('user-input');

    // ----------------------------------------------------
    // EVENT LISTENERS
    // ----------------------------------------------------
    toggleBtn.addEventListener('click', () => {
        chatWidget.classList.toggle('hidden');
    });

    input.addEventListener('keypress', (event) => {
        if (event.key === 'Enter') {
            event.preventDefault();
            sendMessage();
        }
    });

    // Fun√ß√£o auxiliar para o bot√£o de fechar (üóô)
    function triggerClick(idEl) {
        const element = document.getElementById(idEl);
        if (element) {
            element.click();
        }
    }
    
    // ----------------------------------------------------
    // L√ìGICA DE MENSAGENS E INTEGRA√á√ÉO
    // ----------------------------------------------------

    // Inicia o processo de envio e espera pela resposta do Gemini
    function sendMessage() {
        const userMessage = input.value.trim();
        if (!userMessage) {
            return;
        }

        appendMessage('Voc√™', userMessage);
        input.value = '';
        input.disabled = true; // Desabilita o input
        const vies = "Voce √© um especialista em cafe artesanal, responda de forma amigavel em poucas palavras" + userMessage
        getBotResponse(vies); 
    }

    // Faz a chamada ass√≠ncrona para o endpoint Gemini
    async function getBotResponse(userMessage) {
        const loadingMsgId = Date.now();
        appendLoadingMessage(loadingMsgId);
        
        try {
            const response = await fetch(GEMINI_ENDPOINT, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ message: userMessage }),
            });

            const data = await response.json();
            
            removeLoadingMessage(loadingMsgId);

            if (response.ok && data.reply) {
                appendMessage('Cafecito', data.reply);
            } else {
                const errorMsg = data.error || 'Erro desconhecido ao obter resposta.';
                appendMessage('Cafecito', `‚ùå Ops! Erro de comunica√ß√£o: ${errorMsg}`);
            }
        } catch (error) {
            removeLoadingMessage(loadingMsgId);
            console.error('Erro na requisi√ß√£o:', error);
            appendMessage('Cafecito', '‚ö†Ô∏è Erro de rede. Tente novamente.');
        } finally {
            input.disabled = false; // Reabilita o input
            input.focus();
            chatBox.scrollTop = chatBox.scrollHeight;
        }
    }

    // Adiciona uma mensagem de "digitando..."
    function appendLoadingMessage(id) {
        const msg = document.createElement('div');
        msg.id = 'loading-' + id;
        msg.className = 'text-left mb-1';
        msg.innerHTML = `
            <div class="inline-block px-3 py-2 rounded-lg bg-gray-200 text-gray-800 italic">
                <strong>Cafecito</strong>: Digitando...
            </div>`;
        chatBox.appendChild(msg);
        chatBox.scrollTop = chatBox.scrollHeight;
    }

    // Remove a mensagem de "digitando..."
    function removeLoadingMessage(id) {
        const loadingMsg = document.getElementById('loading-' + id);
        if (loadingMsg) {
            loadingMsg.remove();
        }
    }
    
    // Adiciona a mensagem formatada √† caixa de chat
    function appendMessage(sender, message) {
        const isUser = sender === 'Voc√™';
        const msg = document.createElement('div');
        
        // Estilos de mensagens
        // Usu√°rio: Fundo Marrom/Caf√©, Texto Branco
        const userClasses = 'bg-amber-700 text-white'; 
        //  Cafecito: Fundo Cinza Claro, Texto Preto Escuro
        const botClasses = 'bg-gray-200 text-gray-800'; 
        
        msg.className = (isUser ? 'text-right' : 'text-left') + ' mb-2'; 
        msg.innerHTML = `
            <div class="inline-block max-w-[80%] px-3 py-2 rounded-lg shadow-sm ${isUser ? userClasses : botClasses}">
                ${isUser ? '' : '<strong> Cafecito</strong>: '} ${message}
            </div>`;
        
        chatBox.appendChild(msg);
        chatBox.scrollTop = chatBox.scrollHeight;
    }
</script>
    
    <script>
        const iframe = document.querySelector('iframe[name="conteudo"]');
        // ... (c√≥digo da fun√ß√£o ajustarAlturaIframe e chamadas)
        function ajustarAlturaIframe() {
            try {
                // Tenta obter a altura do conte√∫do dentro do iframe
                const alturaConteudo = iframe.contentWindow.document.body.scrollHeight;
                
                // Define a altura do iframe para a altura do seu conte√∫do + uma margem
                if (alturaConteudo > 0) {
                    iframe.style.height = (alturaConteudo + 30) + 'px';
                }
            } catch (e) {
                // Erro de seguran√ßa (CORS) pode acontecer se as p√°ginas n√£o estiverem no mesmo dom√≠nio/porta
                console.warn("N√£o foi poss√≠vel ajustar a altura do iframe: Erro de seguran√ßa ou iframe n√£o carregado.", e);
            }
        }

        // Chama a fun√ß√£o ap√≥s o iframe carregar
        iframe.onload = ajustarAlturaIframe;

        // Tenta ajustar novamente em caso de conte√∫do carregado dinamicamente
        setInterval(ajustarAlturaIframe, 1000); 
    </script>

</body>
</html>